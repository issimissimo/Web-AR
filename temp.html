<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiro ai Palloncini</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #87CEEB 0%, #98D8E8 100%);
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        #instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 16px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas"></canvas>
        <div id="ui">
            <div>Palloncini colpiti: <span id="score">0</span></div>
            <div>Frecce rimanenti: <span id="arrows">10</span></div>
        </div>
        <div id="instructions">
            Premi SPAZIO per lanciare una freccia!
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Variabili globali
        let scene, camera, renderer;
        let balloons = [];
        let arrow = null;
        let isArrowFlying = false;
        let score = 0;
        let arrowsLeft = 10;
        
        // Parametri del gioco
        const ARROW_SPEED = 0.3;
        const GRAVITY = 0.008;
        const GROUND_Y = -10;
        const BALLOON_COUNT = 8;
        
        // Inizializzazione
        init();
        animate();
        
        function init() {
            // Scena
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 8);
            camera.lookAt(0, 0, 0);
            
            // Renderer
            const canvas = document.getElementById('gameCanvas');
            renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // Luci
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // Crea palloncini
            createBalloons();
            
            // Crea freccia iniziale
            createArrow();
            
            // Event listeners
            window.addEventListener('keydown', onKeyPress);
            window.addEventListener('resize', onWindowResize);
        }
        
        function createBalloons() {
            const balloonGeometry = new THREE.SphereGeometry(0.8, 16, 16);
            const colors = [0xff6b6b, 0x4ecdc4, 0x45b7d1, 0x96ceb4, 0xffeaa7, 0xdda0dd, 0xff9ff3, 0x54a0ff];
            
            for (let i = 0; i < BALLOON_COUNT; i++) {
                const balloonMaterial = new THREE.MeshLambertMaterial({ 
                    color: colors[i % colors.length],
                    transparent: true,
                    opacity: 0.9
                });
                
                const balloon = new THREE.Mesh(balloonGeometry, balloonMaterial);
                
                // Posiziona i palloncini in modo sparso
                balloon.position.x = (Math.random() - 0.5) * 12;
                balloon.position.y = Math.random() * 4 + 2;
                balloon.position.z = (Math.random() - 0.5) * 8 - 3;
                
                // Aggiungi una piccola animazione di galleggiamento
                balloon.userData = {
                    originalY: balloon.position.y,
                    floatSpeed: Math.random() * 0.02 + 0.01,
                    floatOffset: Math.random() * Math.PI * 2
                };
                
                balloon.castShadow = true;
                balloon.receiveShadow = true;
                
                scene.add(balloon);
                balloons.push(balloon);
            }
        }
        
        function createArrow() {
            if (arrow) {
                scene.remove(arrow);
            }
            
            // Crea un piccolo cubo come placeholder della freccia
            const arrowGeometry = new THREE.BoxGeometry(0.2, 0.1, 0.6);
            const arrowMaterial = new THREE.MeshLambertMaterial({ color: 0x8B4513 });
            
            arrow = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrow.position.set(0, 1, 6);
            arrow.castShadow = true;
            
            scene.add(arrow);
            
            // Reset delle proprietà di volo
            arrow.userData = {
                velocity: new THREE.Vector3(0, 0, 0),
                isFlying: false
            };
            
            isArrowFlying = false;
        }
        
        function launchArrow() {
            if (isArrowFlying || arrowsLeft <= 0) return;
            
            arrowsLeft--;
            document.getElementById('arrows').textContent = arrowsLeft;
            
            // Imposta la velocità iniziale della freccia
            arrow.userData.velocity.set(0, 0.15, -ARROW_SPEED);
            arrow.userData.isFlying = true;
            isArrowFlying = true;
        }
        
        function updateArrow() {
            if (!isArrowFlying || !arrow.userData.isFlying) return;
            
            // Applica la gravità
            arrow.userData.velocity.y -= GRAVITY;
            
            // Aggiorna la posizione
            arrow.position.add(arrow.userData.velocity);
            
            // Ruota leggermente la freccia per seguire la traiettoria
            arrow.rotation.x = Math.atan2(-arrow.userData.velocity.y, -arrow.userData.velocity.z);
            
            // Controlla le collisioni con i palloncini
            checkCollisions();
            
            // Rimuovi la freccia se va troppo in basso o troppo lontano
            if (arrow.position.y < GROUND_Y || arrow.position.z < -15) {
                setTimeout(() => {
                    if (arrowsLeft > 0) {
                        createArrow();
                    } else {
                        endGame();
                    }
                }, 500);
            }
        }
        
        function checkCollisions() {
            const arrowBox = new THREE.Box3().setFromObject(arrow);
            
            for (let i = balloons.length - 1; i >= 0; i--) {
                const balloon = balloons[i];
                const balloonBox = new THREE.Box3().setFromObject(balloon);
                
                if (arrowBox.intersectsBox(balloonBox)) {
                    // Collisione! Rimuovi il palloncino
                    scene.remove(balloon);
                    balloons.splice(i, 1);
                    
                    // Aggiorna il punteggio
                    score++;
                    document.getElementById('score').textContent = score;
                    
                    // Effetto di "pop" - piccola animazione
                    createPopEffect(balloon.position);
                    
                    // Se tutti i palloncini sono stati colpiti
                    if (balloons.length === 0) {
                        setTimeout(() => {
                            alert('Congratulazioni! Hai colpito tutti i palloncini!');
                            restartGame();
                        }, 500);
                    }
                }
            }
        }
        
        function createPopEffect(position) {
            // Crea un effetto visivo semplice quando un palloncino viene colpito
            const particles = [];
            const particleGeometry = new THREE.SphereGeometry(0.05, 8, 8);
            
            for (let i = 0; i < 8; i++) {
                const particleMaterial = new THREE.MeshLambertMaterial({ 
                    color: Math.random() * 0xffffff,
                    transparent: true,
                    opacity: 0.8
                });
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.copy(position);
                
                const direction = new THREE.Vector3(
                    (Math.random() - 0.5) * 2,
                    Math.random(),
                    (Math.random() - 0.5) * 2
                ).normalize().multiplyScalar(0.1);
                
                particle.userData = { velocity: direction, life: 1.0 };
                scene.add(particle);
                particles.push(particle);
            }
            
            // Anima e rimuovi le particelle
            const animateParticles = () => {
                for (let i = particles.length - 1; i >= 0; i--) {
                    const particle = particles[i];
                    particle.position.add(particle.userData.velocity);
                    particle.userData.velocity.y -= 0.005; // Gravità sulle particelle
                    particle.userData.life -= 0.05;
                    particle.material.opacity = particle.userData.life;
                    
                    if (particle.userData.life <= 0) {
                        scene.remove(particle);
                        particles.splice(i, 1);
                    }
                }
                
                if (particles.length > 0) {
                    requestAnimationFrame(animateParticles);
                }
            };
            animateParticles();
        }
        
        function updateBalloons() {
            // Animazione di galleggiamento per i palloncini
            balloons.forEach((balloon, index) => {
                const time = Date.now() * 0.001;
                balloon.position.y = balloon.userData.originalY + 
                    Math.sin(time * balloon.userData.floatSpeed + balloon.userData.floatOffset) * 0.3;
            });
        }
        
        function onKeyPress(event) {
            if (event.code === 'Space') {
                event.preventDefault();
                launchArrow();
            }
            if (event.code === 'KeyR') {
                restartGame();
            }
        }
        
        function endGame() {
            setTimeout(() => {
                alert(`Gioco finito! Hai colpito ${score} palloncini su ${BALLOON_COUNT}. Premi R per ricominciare.`);
            }, 1000);
        }
        
        function restartGame() {
            // Rimuovi tutti i palloncini rimanenti
            balloons.forEach(balloon => scene.remove(balloon));
            balloons = [];
            
            // Reset delle variabili di gioco
            score = 0;
            arrowsLeft = 10;
            document.getElementById('score').textContent = score;
            document.getElementById('arrows').textContent = arrowsLeft;
            
            // Ricrea palloncini e freccia
            createBalloons();
            createArrow();
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            updateArrow();
            updateBalloons();
            
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>